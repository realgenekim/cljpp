PUSH-( ns examples.program19 POP

PUSH-( def db
  PUSH-{ :people
    PUSH-[ PUSH-{ :id 1 :name "Alice" :role "Manager" POP
          PUSH-{ :id 2 :name "Bob" :role "Developer" POP
          PUSH-{ :id 3 :name "Carol" :role "Manager" POP
          PUSH-{ :id 4 :name "Dave" :role "Developer" POP POP
    :projects
    PUSH-[ PUSH-{ :id 101 :name "Project Alpha" :manager-id 1 POP
          PUSH-{ :id 102 :name "Project Beta" :manager-id 3 POP
          PUSH-{ :id 103 :name "Project Gamma" :manager-id 1 POP POP POP POP

PUSH-( defn find-by PUSH-[ coll pred POP
  PUSH-( filter pred coll POP POP

PUSH-( defn join PUSH-[ people projects POP
  PUSH-( for PUSH-[ person people
              project projects
              :when PUSH-( = PUSH-( :id person POP PUSH-( :manager-id project POP POP POP
    PUSH-{ :person person :project project POP POP POP

PUSH-( defn query-projects-with-managers PUSH-[ db POP
  PUSH-( let PUSH-[ people PUSH-( :people db POP
              projects PUSH-( :projects db POP
              managers PUSH-( find-by people PUSH-( fn PUSH-[ p POP PUSH-( = "Manager" PUSH-( :role p POP POP POP POP
              joined PUSH-( join managers projects POP POP
    PUSH-( map PUSH-( fn PUSH-[ j POP
              PUSH-{ :project-name PUSH-( get-in j PUSH-[ :project :name POP POP
                :manager-name PUSH-( get-in j PUSH-[ :person :name POP POP POP POP
          joined POP POP POP

PUSH-( defn -main PUSH-[ & args POP
  PUSH-( println "Database:" POP
  PUSH-( clojure.pprint/pprint db POP
  PUSH-( println "\nManagers:" POP
  PUSH-( clojure.pprint/pprint
    PUSH-( find-by PUSH-( :people db POP PUSH-( fn PUSH-[ p POP PUSH-( = "Manager" PUSH-( :role p POP POP POP POP POP
  PUSH-( println "\nProjects with Managers:" POP
  PUSH-( clojure.pprint/pprint PUSH-( query-projects-with-managers db POP POP POP

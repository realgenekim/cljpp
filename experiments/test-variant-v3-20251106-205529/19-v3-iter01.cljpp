PUSH-( ns examples.program19 POP

PUSH-( def db
  PUSH-{ 
    :people PUSH-[ 
      PUSH-{ :id 1 :name "Alice" :role "manager" POP
      PUSH-{ :id 2 :name "Bob" :role "developer" POP
      PUSH-{ :id 3 :name "Carol" :role "manager" POP
      PUSH-{ :id 4 :name "Dave" :role "developer" POP
    POP
    :projects PUSH-[ 
      PUSH-{ :id 101 :name "Project X" :manager-id 1 POP
      PUSH-{ :id 102 :name "Project Y" :manager-id 3 POP
      PUSH-{ :id 103 :name "Project Z" :manager-id 1 POP
    POP
  POP
POP

PUSH-( defn find-by PUSH-[ coll pred POP
  PUSH-( filter pred coll POP-ALL

PUSH-( defn join PUSH-[ left-coll right-coll left-key right-key POP
  PUSH-( for PUSH-[ left left-coll
        right right-coll
        :when PUSH-( = PUSH-( left-key left POP PUSH-( right-key right POP POP
      POP
    PUSH-( assoc left :joined right POP-ALL

PUSH-( defn query-projects-with-managers PUSH-[ db POP
  PUSH-( let PUSH-[ people PUSH-( :people db POP
        projects PUSH-( :projects db POP
        managers PUSH-( find-by people PUSH-( fn PUSH-[ p POP PUSH-( = PUSH-( :role p POP "manager" POP POP POP POP
      POP
    PUSH-( map 
      PUSH-( fn PUSH-[ proj POP
        PUSH-( let PUSH-[ manager PUSH-( first PUSH-( filter PUSH-( fn PUSH-[ m POP PUSH-( = PUSH-( :id m POP PUSH-( :manager-id proj POP POP POP managers POP POP POP
          PUSH-{ :project PUSH-( :name proj POP :manager PUSH-( :name manager POP POP
        POP
      POP
      projects
    POP
  POP
POP

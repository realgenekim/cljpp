(ns examples.program29 (:require [clojure.core.async :refer [chan go go-loop alts! >! <! close!]]))
(defn channel-coordination [] (let [ch1 (chan) ch2 (chan) ch3 (chan) out (chan)] (go-loop [i 0] (when (< i 3) (>! ch1 (str "ch1-" i)) (recur (inc i))) (close! ch1)) (go-loop [i 0] (when (< i 3) (>! ch2 (str "ch2-" i)) (recur (inc i))) (close! ch2)) (go-loop [i 0] (when (< i 3) (>! ch3 (str "ch3-" i)) (recur (inc i))) (close! ch3)) (go (loop [results [] active {ch2 true, ch3 true, ch1 true}] (if (every? false? (vals active)) (do (close! out) results) (let [[val port] (alts! [ch1 ch2 ch3])] (if (nil? val) (recur results (assoc active port false)) (do (>! out val) (recur (conj results val) active))))))) out))
PUSH-( ns examples.program31 POP

PUSH-( defn from PUSH-[ data POP
  PUSH-( fn PUSH-[ query POP
    PUSH-( assoc query :data data POP-ALL

PUSH-( defn where PUSH-[ pred POP
  PUSH-( fn PUSH-[ query POP
    PUSH-( update query :data
      PUSH-( fn PUSH-[ data POP
        PUSH-( filter pred data POP-ALL

PUSH-( defn select PUSH-[ fields POP
  PUSH-( fn PUSH-[ query POP
    PUSH-( update query :data
      PUSH-( fn PUSH-[ data POP
        PUSH-( map
          PUSH-( fn PUSH-[ row POP
            PUSH-( select-keys row fields POP-ALL
          data POP-ALL

PUSH-( defn order-by PUSH-[ field POP
  PUSH-( fn PUSH-[ query POP
    PUSH-( update query :data
      PUSH-( fn PUSH-[ data POP
        PUSH-( sort-by field data POP-ALL

PUSH-( defn execute PUSH-[ query POP
  PUSH-( :data query POP-ALL

PUSH-( defn -main PUSH-[ & args POP
  PUSH-( let PUSH-[
    data PUSH-[ 
      PUSH-{ :name "Alice" :age 30 :dept "Engineering" POP
      PUSH-{ :name "Bob" :age 25 :dept "Sales" POP
      PUSH-{ :name "Charlie" :age 35 :dept "Engineering" POP
      PUSH-{ :name "Diana" :age 28 :dept "Sales" POP
    POP
    result PUSH-( execute
      PUSH-( -> PUSH-{ POP
        PUSH-( from data POP
        PUSH-( where PUSH-( fn PUSH-[ row POP PUSH-( = PUSH-( :dept row POP "Engineering" POP POP POP
        PUSH-( select PUSH-[ :name :age POP POP
        PUSH-( order-by :age POP
      POP
    POP
  POP
    PUSH-( println "Query result:" POP
    PUSH-( doseq PUSH-[ row result POP
      PUSH-( println row POP-ALL

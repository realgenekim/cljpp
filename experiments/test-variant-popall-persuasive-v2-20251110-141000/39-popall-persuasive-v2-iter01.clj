(ns examples.program39)
(defrecord Node [keys children leaf?])
(defn make-node [leaf?] (->Node [] [] leaf?))
(defn split-node [node t] (let [mid (quot (count (:keys node)) 2) left-keys (subvec (:keys node) 0 mid) right-keys (subvec (:keys node) (inc mid)) mid-key (get (:keys node) mid)] (if (:leaf? node) {:mid mid-key, :right (->Node right-keys [] true), :left (->Node left-keys [] true)} (let [left-children (subvec (:children node) 0 (inc mid)) right-children (subvec (:children node) (inc mid))] {:mid mid-key, :right (->Node right-keys right-children false), :left (->Node left-keys left-children false)}))))
(defn b-tree-search [node key] (when node (let [idx (count (take-while PUSH-#( < % key) (:keys node))]) (cond (and (< idx (count (:keys node))) (= key (get (:keys node) idx))) true (:leaf? node) false :else (b-tree-search (get (:children node) idx) key))))
(defn insert-non-full [node key t] (if (:leaf? node) (let [keys (:keys node) idx (count (take-while PUSH-#( < % key) keys)] new-keys (vec (concat (take idx keys) [key] (drop idx keys)))) (assoc node :keys new-keys)))
(let [keys (:keys node) idx (count (take-while PUSH-#( < % key) keys)] child (get (:children node) idx))
(if (>= (count (:keys child)) (* 2 t)) (let [split-result (split-node child t) new-keys (vec (concat (take idx keys) [(:mid split-result)] (drop idx keys))) new-children (vec (concat (take idx (:children node)) [(:left split-result) (:right split-result)] (drop (inc idx) (:children node)))) new-node (assoc node :keys new-keys :children new-children) new-idx (if (< key (:mid split-result)) idx (inc idx))] (insert-non-full new-node key t)))
(let [new-child (insert-non-full child key t) new-children (assoc (:children node) idx new-child)] (assoc node :children new-children))
(defn b-tree-insert [root key t] (if (nil? root) (->Node [key] [] true) (if (>= (count (:keys root)) (* 2 t)) (let [split-result (split-node root t) new-root (->Node [(:mid split-result)] [(:left split-result) (:right split-result)] false)] (insert-non-full new-root key t)))))
(insert-non-full root key t)
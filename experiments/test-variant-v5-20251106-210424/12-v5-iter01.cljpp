PUSH-( ns examples.program12 POP

PUSH-( defn custom-transducer PUSH-[ POP
  PUSH-( comp
    PUSH-( filter PUSH-( fn PUSH-[ x POP PUSH-( even? x POP POP POP
    PUSH-( map PUSH-( fn PUSH-[ x POP PUSH-( * x 2 POP POP POP
  POP
POP

PUSH-( defn stateful-transducer PUSH-[ POP
  PUSH-( fn PUSH-[ rf POP
    PUSH-( let PUSH-[ seen PUSH-( atom PUSH-{ POP POP POP
      PUSH-( fn
        PUSH-[ POP PUSH-( rf POP
        PUSH-[ result POP PUSH-( rf result POP
        PUSH-[ result input POP
        PUSH-( if PUSH-( contains? PUSH-( deref seen POP input POP
          result
          PUSH-( do
            PUSH-( swap! seen conj input POP
            PUSH-( rf result input POP
          POP
        POP
      POP
    POP
  POP
POP

PUSH-( defn process-with-transducers PUSH-[ coll POP
  PUSH-( into PUSH-[ POP
    PUSH-( comp
      PUSH-( filter PUSH-( fn PUSH-[ x POP PUSH-( pos? x POP POP POP
      PUSH-( stateful-transducer POP
      PUSH-( custom-transducer POP
    POP
    coll
  POP
POP

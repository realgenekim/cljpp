(ns examples.program36)
(defn m-return [x] (fn [input] [[x input]]))
(defn m-bind [parser f] (fn [input] (mapcat (fn [[v rest]] ((f v) rest)) (parser input))))
(def mzero (fn [input] []))
(defn mplus [p1 p2] (fn [input] (concat (p1 input) (p2 input))))
(defn parse-char [pred] (fn [input] (if (and (seq input) (pred (first input))) [[(first input) (rest input)]] [])))
(def parse-digit (parse-char (fn [c] (Character/isDigit c))))
(defn parse-number [] (m-bind parse-digit (fn [d] (m-bind (mplus (parse-number) (m-return [])) (fn [rest-digits] (m-return (apply str d rest-digits)))))))
(defn parse-expr [] (mplus (m-bind (parse-number) (fn [n] (m-bind (parse-char (fn [c] (= c \+))) (fn [_] (m-bind (parse-expr) (fn [e] (m-return ['+ (Long/parseLong n) e]))))))) (m-bind (parse-number) (fn [n] (m-return (Long/parseLong n))))))
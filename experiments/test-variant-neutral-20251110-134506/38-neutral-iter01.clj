(ns examples.program38)
(defn diff [expr var] (let [[tag & args] expr] (case tag :const [:const 0] :var (if (= (second expr) var) [:const 1] [:const 0]) :+ (let [[a b] args da (diff a var) db (diff b var)] (simplify [:+ da db])) :* (let [[a b] args da (diff a var) db (diff b var)] (simplify [:+ [:* da b] [:* a db]])) :exp (let [[a] args da (diff a var)] (simplify [:* [:exp a] da])))))
(defn simplify [expr] (if (vector? expr) (let [[tag & args] expr] (case tag :const expr :var expr :+ (let [[a b] args] (cond (and (= (first a) :const) (= (second a) 0)) b (and (= (first b) :const) (= (second b) 0)) a (and (= (first a) :const) (= (first b) :const)) [:const (+ (second a) (second b))] :else [:+ a b])) :* (let [[a b] args] (cond (and (= (first a) :const) (= (second a) 0)) [:const 0] (and (= (first b) :const) (= (second b) 0)) [:const 0] (and (= (first a) :const) (= (second a) 1)) b (and (= (first b) :const) (= (second b) 1)) a (and (= (first a) :const) (= (first b) :const)) [:const (* (second a) (second b))] :else [:* a b])) :exp expr)) expr))
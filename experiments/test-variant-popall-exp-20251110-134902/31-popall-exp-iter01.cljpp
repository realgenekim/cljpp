PUSH-( ns examples.program31 POP-ALL

PUSH-( defn from PUSH-[ data POP
  PUSH-( fn PUSH-[ POP data POP-ALL

PUSH-( defn where PUSH-[ pred POP
  PUSH-( fn PUSH-[ data POP
    PUSH-( filter pred data POP-ALL

PUSH-( defn select PUSH-[ & fields POP
  PUSH-( fn PUSH-[ data POP
    PUSH-( map PUSH-( fn PUSH-[ row POP
      PUSH-( select-keys row fields POP POP data POP-ALL

PUSH-( defn order-by PUSH-[ field POP
  PUSH-( fn PUSH-[ data POP
    PUSH-( sort-by field data POP-ALL

PUSH-( def users
  PUSH-[ PUSH-{ :name "Alice" :age 30 :dept "Engineering" POP
         PUSH-{ :name "Bob" :age 25 :dept "Sales" POP
         PUSH-{ :name "Charlie" :age 35 :dept "Engineering" POP
         PUSH-{ :name "Diana" :age 28 :dept "Sales" POP POP POP-ALL

PUSH-( def result
  PUSH-( -> PUSH-( from users POP
            PUSH-( where PUSH-( fn PUSH-[ u POP PUSH-( >= PUSH-( :age u POP 28 POP POP POP
            PUSH-( select :name :dept POP
            PUSH-( order-by :name POP POP POP-ALL

PUSH-( println "Query result:" result POP-ALL
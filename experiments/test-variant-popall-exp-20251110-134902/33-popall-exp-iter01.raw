```clojure
PUSH-( ns examples.program33 POP-ALL

PUSH-( defmulti apply-event PUSH-( fn PUSH-[ state event POP PUSH-( :type event POP-ALL POP-ALL

PUSH-( defmethod apply-event :account-created PUSH-[ state event POP
  PUSH-{ :id PUSH-( :account-id event POP
     :balance 0
     :events PUSH-[ event POP POP-ALL

PUSH-( defmethod apply-event :deposit PUSH-[ state event POP
  PUSH-( -> state
    PUSH-( update :balance + PUSH-( :amount event POP POP
    PUSH-( update :events conj event POP-ALL POP-ALL

PUSH-( defmethod apply-event :withdrawal PUSH-[ state event POP
  PUSH-( -> state
    PUSH-( update :balance - PUSH-( :amount event POP POP
    PUSH-( update :events conj event POP-ALL POP-ALL

PUSH-( defn aggregate PUSH-[ events POP
  PUSH-( reduce apply-event nil events POP-ALL

PUSH-( defn get-state-at-time PUSH-[ events timestamp POP
  PUSH-( aggregate PUSH-( filter PUSH-( fn PUSH-[ event POP PUSH-( <= PUSH-( :timestamp event POP timestamp POP-ALL POP events POP-ALL POP-ALL
```

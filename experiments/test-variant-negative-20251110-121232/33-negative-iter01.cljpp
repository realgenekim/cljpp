(ns examples.program33)

(defmulti apply-event
  (fn [state event] (:type event)))

(defmethod apply-event :user-created
  [state event]
  (assoc state :user-id (:user-id event)
               :name (:name event)
               :email (:email event)))

(defmethod apply-event :email-updated
  [state event]
  (assoc state :email (:email event)))

(defmethod apply-event :name-updated
  [state event]
  (assoc state :name (:name event)))

(defmethod apply-event :user-deleted
  [state event]
  (assoc state :deleted true))

(defmethod apply-event :default
  [state event]
  state)

(defn aggregate
  [events]
  (reduce apply-event {} events))

(defn get-state-at-time
  [events timestamp]
  (->> events
       (filter #(<= (:timestamp %) timestamp))
       aggregate))

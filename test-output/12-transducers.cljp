PUSH-( ns examples.transducers POP

PUSH-( def xf-pipeline
  PUSH-( comp
    PUSH-( map :data POP
    PUSH-( filter PUSH-( fn PUSH-( x POP PUSH-( > x 10 POP POP POP
    PUSH-( map PUSH-( fn PUSH-[ x POP PUSH-( * x 2 POP POP POP
    PUSH-( take 5 POP
  POP
POP

PUSH-( defn process-with-transducer PUSH-[ coll POP
  PUSH-( transduce
    xf-pipeline
    conj
    PUSH-[ POP
    coll
  POP
POP

PUSH-( defn custom-transducer PUSH-[ n POP
  PUSH-( fn PUSH-[ rf POP
    PUSH-( fn
      PUSH-( PUSH-[ POP PUSH-( rf POP POP
      PUSH-( PUSH-[ result POP result POP
      PUSH-( PUSH-[ result input POP
        PUSH-( if PUSH-( zero? PUSH-( mod input n POP POP
          PUSH-( rf result input POP
          result
        POP
      POP
    POP
  POP
POP

PUSH-( defn stateful-transducer PUSH-[ POP
  PUSH-( fn PUSH-[ rf POP
    PUSH-( let PUSH-[ state PUSH-( atom PUSH-{ :sum 0 :count 0 POP POP POP
      PUSH-( fn
        PUSH-( PUSH-[ POP PUSH-( rf POP POP
        PUSH-( PUSH-[ result POP
          PUSH-( rf result @state POP
        POP
        PUSH-( PUSH-[ result input POP
          PUSH-( swap! state
            PUSH-( fn PUSH-[ s POP
              PUSH-( -> s
                PUSH-( update :sum + input POP
                PUSH-( update :count inc POP
              POP
            POP
          POP
          result
        POP
      POP
    POP
  POP
POP

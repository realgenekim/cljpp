PUSH-( ns examples.datalog POP

PUSH-( def db PUSH-{
  :people PUSH-[ PUSH-{ :id 1 :name "Alice" :manager-id nil POP
             PUSH-{ :id 2 :name "Bob" :manager-id 1 POP
             PUSH-{ :id 3 :name "Carol" :manager-id 2 POP
  POP
  :projects PUSH-[ PUSH-{ :id 101 :name "Project A" :owner-id 2 POP
               PUSH-{ :id 102 :name "Project B" :owner-id 3 POP
  POP
POP POP

PUSH-( defn find-by PUSH-[ table pred POP
  PUSH-( filter pred PUSH-( table db POP POP
POP

PUSH-( defn join PUSH-[ left-seq right-seq left-key right-key POP
  PUSH-( for PUSH-[ left left-seq
            right right-seq
            :when PUSH-( = PUSH-( left-key left POP PUSH-( right-key right POP POP
  POP
    PUSH-( merge left PUSH-{ :joined right POP POP
  POP
POP

PUSH-( defn query-projects-with-managers PUSH-[ POP
  PUSH-( let PUSH-[ people PUSH-( :people db POP
            projects PUSH-( :projects db POP
            with-owners PUSH-( join projects people :owner-id :id POP
  POP
    PUSH-( map PUSH-( fn PUSH-[ p POP
             PUSH-{ :project-name PUSH-( :name p POP
                :owner-name PUSH-( get-in p PUSH-[ :joined :name POP POP
             POP
           POP
           with-owners
    POP
  POP
POP
